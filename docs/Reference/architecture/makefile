# Makefile for PlantUML
# Based on GistID: 52eacde54bf7861b19ee66a07b864583 with some small alterations
#
# This handles SVGs PNGs and ASCII outputs.
# It handles included files with the .puml extension: !include foo.puml
# All diagrams have the .puml extension and reside in the SRC directory
# All output is saved to the output directory
#
# make svg    - (default) build all diagrams as SVGs
# make png    - build all diagrams as PNGs
# make ascii  - build all diagrams as ACII Art text files (.atxt)
# make all    - build SVG, PNG, and ASCII files
# make depend - build the dependency cache (also done automatically)
# make clean  - clean up build artifacts and output files
#
# Diagrams can be built in parallel with `make -j`.

PLANTUML = plantuml

SRC = src
OUTPUT = out
DEPEND = .depend
SRC_SUFFIX = .puml

SRC_FILES := $(wildcard $(SRC)/*$(SRC_SUFFIX))

.PHONY: default all depend clean ascii svg png atxt

default: svg

all: svg png ascii

depend: $(DEPEND)
 
clean:
	rm -rf $(OUTPUT) $(DEPEND)

ascii: atxt

svg png atxt: $(DEPEND)
	@$(MAKE) $(patsubst $(SRC)/%$(SRC_SUFFIX),$(OUTPUT)/%.$@,$(shell ls -1t $(SRC_FILES)))

$(OUTPUT)/%.svg: $(SRC)/%.puml
	$(PLANTUML) -tsvg $< -o ../$(OUTPUT)

$(OUTPUT)/%.png: $(SRC)/%.puml
	$(PLANTUML) -tpng $< -o ../$(OUTPUT)

$(OUTPUT)/%.atxt: $(SRC)/%.puml
	$(PLANTUML) -ttxt $< -o ../$(OUTPUT)

$(DEPEND): $(SRC_FILES)
	@find_includes() { \
		sed \
			-e "s,^[[:space:]]*!include \([^<].*[^>]\)$$,$${1}/\1," \
			-e t -e d "$$2" \
			| paste -sd " " -; \
	}; \
	echo "# GENERATED BY make depend" > $@; \
	echo "# DO NOT EDIT" >> $@; \
	echo >> $@; \
	for file in $^; do \
		name="$$(basename -s .uml "$$file")"; \
		includes="$$(find_includes "$(SRC)" "$$file")"; \
		printf "$(OUTPUT)/%s.svg: %s\n" "$$name" "$$includes"; \
		printf "$(OUTPUT)/%s.png: %s\n" "$$name" "$$includes"; \
		printf "$(OUTPUT)/%s.atxt: %s\n" "$$name" "$$includes"; \
	done >> $@

-include $(DEPEND)